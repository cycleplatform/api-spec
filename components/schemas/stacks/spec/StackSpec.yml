$schema: "https://json-schema.org/draft/2020-12/schema"
title: StackSpec
description: |
  A Cycle stack file is an "environment as code". Anything that can be done in an environment on Cycle can be described in a stack file and deployed as a new environment.
  Stack files can list multiple containers and their configurations, load balancer settings, scoped variables, and much more.
type: object
required:
  - version
  - containers
properties:
  version:
    type: string
    description: The version of the Cycle stack file used.
    enum:
      - "1.0"
  about:
    description: Various properties describing this stack.
    type:
      - object
      - "null"
    required:
      - description
      - version
    properties:
      version:
        type: string
        description: A custom, user-defined version of the stack.
      description:
        type: string
        description: Custom, user-defined details about this stack.
  # tests:
  #   description: |
  #     An array of containers that are deployed as part of a stack. Test containers run once and should exit with 0 on success. If all exit successfully, the stack is considered deployed.

  #     **Not currently implemented.**
  #   type:
  #     - array
  #     - "null"
  #   items:
  #     $ref: StackSpecTestContainer.yml
  scoped_variables:
    description: Describes variables that are assigned to one or more containers at runtime. Can be assigned as an environment variable, written as a file inside the container(s), or accessed over the internal API.
    type:
      - array
      - "null"
    items:
      $ref: ./StackSpecScopedVariable.yml
  containers:
    type: object
    description: A mapping of containers that will be deployed as a part of this stack. The key is used as the container's identifier.
    additionalProperties:
      $ref: ./StackContainer.yml
  services:
    title: StackSpecServices
    type:
      - object
      - "null"
    properties:
      discovery:
        type:
          - object
          - "null"
        properties:
          hosts:
            type:
              - object
              - "null"
            additionalProperties:
              type: object
              properties:
                ipv4:
                  type:
                    - array
                    - "null"
                  items:
                    type: string
                ipv6:
                  type:
                    - array
                    - "null"
                  items:
                    type: string
      loadbalancer:
        anyOf:
          - $ref: services/loadbalancer/StackSpecLoadBalancerConfig.yml
          - type: "null"
      vpn:
        type: object
        required:
          - auth
          - allow_internet
        properties:
          auth:
            type: object
            required:
              - cycle_accounts
              - vpn_accounts
            properties:
              webhook:
                type: string
              cycle_accounts:
                type: boolean
              vpn_accounts:
                type: boolean
          allow_internet:
            type: boolean
  annotations:
    type: object
    description: Additional meta info about the stack.
    additionalProperties: {}
